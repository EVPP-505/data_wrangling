---
title: "Data Wrangling in R"
output: html_notebook
---

Today we are going to learn about data wrangling.  What does it mean to "wrangle data"?  Simply put, wrangling your data is making your 


Primarily uses `dplyr` and `tidyr`
```{r}
library(dplyr)
library(tidyr)
```


`tbl_df` aka tibbles

Mostly just a pretty way to view large (wide and/or long) data.

`View()` (with a Capital V!)
opens a spreadsheet-like view of your data to quickly visualize and filter the results.


Pipes `%>%`

are used for "chaining" results together

```{r}
# singular, line-by-line method to round a column and calculate the mean
# extract the column and round
# mtcars is a built in dataset to play with
mpg_v <- round(mtcars$mpg, 2)
# calculate the mean
mean(mpg_v)

```

```{r}
# using a piped method
mtcars$mpg %>% 
  round(2) %>% 
  mean()
```


Tidy data

This is the format we have been working with.  Each *variable* in our data is a **column** and each *observation* is in a **row**.  Remember, R is vectorized, meaning our variables are vectors of data over which we can quickly and efficiently perform operations.

Untidy data is a format that does not follow the variable/observation format.  Consider the following:

```{r}
untidy_df <- tibble(country = c("US", "CA", "DE"),
                    `2010` = c(7000, 6500, 5000),
                    `2015` = c(3000, 4500, 6000),
                    `2017` = c(1500, 2000, 7000)
                    )
untidy_df
```

These data are in a format that does not allow for easy manipulation of the variables.  In this case, we cannot, for example, quickly extract years using a single variable `year`.

This is not an uncommon format for data.  It's not that the untidy data cannot be used in R.  Rather, the format makes indexing the variables more difficult, and more complex code is required to make this work. 

We can `gather` the data into the format that R prefers.  We might want three columns with `country`, `year`, `n`.  We do this by using key, value pairs.  A key column contains the values from former column names, and a value column contains the values from each of those.

```{r gather}
# gather the untidy data into a tidy format.  The country column will be maintained
tidy_df <- gather(untidy_df, 
                  key = "year", 
                  value = "n", 
                  2:4) #the columns to use
tidy_df
```

Notice that the country column values are replicated as needed to create observations.  This might seem redundant compared to the untidy example, but you will see how this tidy data is really powerful.

## The dplyr Package

We can now use this tidy data to find specific answers to questions.  `dplyr` has a core set of functions that will be most helpful.  Most of the functions The full set of functions can be found in the (Data Transformation Cheatsheet)[https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf].


`Select()`
simplifies the extraction of columns (variables) of data.

```{r}
# look at the structure of the data
mtcars
# select just a few columns
mtcars %>% 
  select(mpg, cyl, disp, hp)
```

```{r}
# now try it using a range selection to get the same set
mtcars %>% 
  select(1:4)
```

```{r}
# select by inverse
mtcars %>% 
  select(-carb, -gear, -am)
```


`filter()`
simplifies the extraction of rows (observations) meeting some criteria

```{r}
mtcars %>% 
  filter(mpg > 20)
```


`mutate()`
generate new variables.  We can generate multiple
window functions = return a result of the same length as the input

```{r}
mtcars %>% 
  mutate(ratio = qsec / disp)
```

`summarize()`
calculate summary statistics

```{r}
mtcars %>% 
  summarise(avg_mpg = mean(mpg))
```


`arrange()`
Changes order of your data basing
desc() = descending (highest to lowest)
can do multiple columns (this, then by that)
```{r}
# sort by increasing displacement
mtcars %>% 
  arrange(disp)
```

```{r}
# sort by decreasing displacement
mtcars %>% 
  arrange(desc(disp))
```

More complex
`group_by()`

```{r}
tidy_df %>% 
  group_by(country) %>% 
  summarise(mean = mean(n), sum = sum(n), n = n())
```

This is not a great data set, but you can continue to group the data set into more groups and summarize.

```{r}
tidy_df %>% 
  group_by(country, year) %>% 
  summarise(cases = sum(n)) %>% 
  summarise(cases = sum(cases))
```


Now, let's take a look at some of your data...
